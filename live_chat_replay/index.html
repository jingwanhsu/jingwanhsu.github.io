<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <title>上課囉！</title>
  </head>
  <body>
    <div class="mdc-layout-grid">
      <div class="mdc-layout-grid__inner">
        <div class="mdc-layout-grid__cell--span-9">
          <input id="video_input" type="file" accept="video/*"/>
          <video id="video" controls autoplay>
            <!-- <source src="video.mp4" type="video/mp4">
            <p>Your browser doesn't support HTML5 video. Here is a <a href="video.mp4">link to the video</a> instead.</p> -->
          </video>
        </div>
        <div class="mdc-layout-grid__cell--span-3">
          <input id="start_time" value="06/01/2022 18:49:07" />
          <input type="file" name="inputfile" id="inputfile" />
          <div id="chatroom" style="height: 80vh; overflow: scroll">
          </div>
        </div>
      </div>
    </div>
    <script>
      var URL = window.URL || window.webkitURL;
      const video = document.getElementById('video');
      var inputNode = document.getElementById('video_input');
      inputNode.addEventListener('change', function() {
        var fileURL = URL.createObjectURL(this.files[0])
        video.src = fileURL;
      }, false);

      const chatroom = document.getElementById('chatroom');
      let chats = [];
      video.ontimeupdate = () => {
        const scrollToBottom = chatroom.scrollTop + chatroom.clientHeight === chatroom.scrollHeight;
        chatroom.innerText = chats
          .filter(chat => chat[0] < video.currentTime)
          .map(chat => `${chat[1]}: ${chat[2]}`);
        if (scrollToBottom) {
          chatroom.scrollTop = chatroom.scrollHeight;
        }
      };
      document.getElementById('inputfile').addEventListener('change', function() {
        const fr = new FileReader();
        fr.onload = () => {
          const startTimeStr = document.getElementById('start_time').value;
          const startTime = new Date(startTimeStr);
          const dateStr = startTimeStr.split(' ')[0];
          chats = fr.result.split(dateStr).slice(1).map(line => {
            const chat = line.split(/\ PM\ 來自\ |\ 至所有人:\ /);
            chat[0] = (new Date(dateStr + chat[0]) - startTime) / 1000;
            return chat;
          });
        }
        fr.readAsText(this.files[0]);
      })
    </script>
  </body>
</html>